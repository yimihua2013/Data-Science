<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Getting Started with Matching Methods | University of Virginia Library Research Data Services + Sciences</title>
  <meta name="description" content="Collections, services, branches, and contact information." />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="shortcut icon" href="/wp-content/themes/libweb-base/img/favicon.ico" />
  <link rel="stylesheet" href="/wp-content/themes/libweb-base/css/1140/1140.css">
	<link rel="stylesheet" href="/wp-content/themes/libweb-base/css/style.css">
	<!--[if lt IE 8]><link rel="stylesheet" href="/wp-content/themes/libweb-base/css/1140/ie.css"><![endif]-->
  <link rel="stylesheet" href="/wp-content/themes/libweb-base/css/bootstrap-custom.min.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="alternate" type="application/rss+xml" title="Research Data Services + Sciences Feed" href="https://data.library.virginia.edu/feed/">
  <link rel='dns-prefetch' href='//s.w.org' />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11.2.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11.2.0\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.1.1"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel="stylesheet" href="/wp-includes/css/dist/block-library/style.min.css?ver=5.1.1">
<link rel="stylesheet" href="/wp-content/plugins/announcer/public/announcer-styles.css?ver=5.1.1">
<script type='text/javascript' src='/wp-content/themes/libweb-base/js/libs/jquery-1.7.1.min.js?ver=1.7.1'></script>
<script type='text/javascript' src='/wp-content/plugins/announcer/public/announcer-js.js?ver=5.1.1'></script>
<link rel='https://api.w.org/' href='https://data.library.virginia.edu/wp-json/' />
<link rel="alternate" type="application/json+oembed" href="https://data.library.virginia.edu/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fdata.library.virginia.edu%2Fgetting-started-with-matching-methods%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://data.library.virginia.edu/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fdata.library.virginia.edu%2Fgetting-started-with-matching-methods%2F&#038;format=xml" />
	<link rel="canonical" href="https://data.library.virginia.edu/getting-started-with-matching-methods/">
    <link href='//wp.library.virginia.edu/css/include.css' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700' rel='stylesheet' type='text/css'>
  <script src="//static.lib.virginia.edu/js/controllers/libweb-base.js"></script>
  <script src="/wp-content/themes/libweb-base/js/libs/modernizr-2.5.3-custom.min.js"></script>
  <script type="text/javascript"
    src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

</head>
<body class="post-template-default single single-post postid-6579 single-format-standard statlab-articles no-bg">
<noscript>
    <div  style="background-color: #ffffff; text: #000; padding: 5px;">
        JavaScript must be enabled in order for you to use our website. However, it seems JavaScript is either disabled or not supported by your browser.
    </div>
</noscript>

    <div id="wrap" role="document">
    <div id="jump-menu" class="visuallyhidden">
      Jump to:
      <ul>
        <li><a href="#content">Main content</a></li>
        <li><a href="#main-nav">Main navigation</a></li>
        <li id="searchlink" style="display:none"><a href="#search">Search</a></li>
        <li><a href="https://www.library.virginia.edu/services/accessibility-services/">Accessibility Services</a></li>
      </ul>
      <script>
        $(function(){ if( $('#search, [name="search"]').length > 0){ $('#searchlink').show(); }  });
      </script>
    </div>
    <div class="container top-container">
      <div class="row top-row">
        <nav class="sixcol" id="main-nav">
          <h3 class="visuallyhidden">U.Va. Links</h3>
          <ul>
            <li><a class="return-home" href="https://data.library.virginia.edu/">Research Data Services + Sciences Home</a></li>
            <li><a href="http://www.virginia.edu">U.Va. Home</a></li>
            <li><a href="https://library.virginia.edu">U.Va. Library</a></li>
          </ul>
        </nav>
        <div class="sixcol last">
                  </div>
      </div>
    </div>
  <div class="container header-container"><div class="row header-row clearfix">
    <header id="top-banner" class="twelvecol" role="banner">
            <div class="container">
        <h1 class="ninecol" id="main-title">
          <a href="https://data.library.virginia.edu/">
            <span class="donor-title">University of Virginia Library</span>
            <span class="library-title">Research Data Services + Sciences</span>
        </a></h1>
        <a class="threecol last" id="logo" href="https://library.virginia.edu" aria-label="University of Virginia Library">
          <img src="/wp-content/themes/libweb-base/img/liblogo.png" width="198" height="90" alt="University of Virginia Library">
        </a>
      </div>
    </header>
  </div></div><!-- /.row /.container -->
<div class="container content-container"><div class="row content-row clearfix">
      <div id="content" class="row">
          <div id="main" class="ninecol" role="main">
        <div class="container">
                          <article class="post-6579 post type-post status-publish format-standard hentry category-statlab-articles tag-clay-ford tag-matching tag-propensity-scores tag-r tag-statistical-methods" id="post-6579">
          <header>
        <h1 class="entry-title">Getting Started with Matching Methods</h1>
        <time class="updated" datetime="2018-04-25T13:57:28+00:00" pubdate>Posted on Wednesday, April 25th, 2018 at 1:57 pm.</time><p class="byline author vcard">Written by <a href="https://data.library.virginia.edu/author/jcf2d/" rel="author" class="fn">jcf2d</a></p>      </header>
      <div class="entry-content">
        <p>A frequent research question is whether or not some &#8220;treatment&#8221; causes an effect. For example, does taking aspirin daily reduce the chance of a heart attack? Does more sleep lead to better academic performance for teenagers? Does smoking increase the risk of chronic obstructive pulmonary disease (COPD)?</p>
<p>To truly answer such questions, we need a time machine and a lack of ethics. We would need to be able to take a subject and, say, make him or her smoke for several years and observe whether or not they get COPD. Then travel back in time and observe the same subject NOT smoking to see if they get COPD. Only then could we really see the effect of smoking on that person&#8217;s chances of contracting COPD. To estimate the average effect of smoking on COPD, we would need to do the same with many subjects. Clearly the laws of physics and all IRBs forbid this.</p>
<p>To work around these issues researchers often employ what are called &#8220;matching methods&#8221;. This involves taking observational data, such as data from surveys, and matching people who have similar characteristics but different treatments. I can&#8217;t travel through time and make a person smoke and not smoke. But I can identify two people who are similar in almost every way except their smoking status. Here&#8217;s a 200-pound, middle class, college educated, Caucasian man who smokes, and a 200-pound, middle class, college educated, Caucasian man who does NOT smoke. They&#8217;re not the same people but they&#8217;re similar. It stands to reason the effects of smoking on the smoker can approximate the effect of smoking on the non-smoker, and vice versa. This is the idea of matching methods: create two such groups that are similar in every respect but their treatment.</p>
<p>For a fantastic and easy-to-read overview of matching methods, see Elizabeth Stuart&#8217;s 2010 paper &#8220;<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2943670/" rel="noopener" target="_blank">Matching Methods for Causal Inference: A Review and a Look Forward</a>&#8220;. See also Michele Claibourn&#8217;s excellent <a href="http://static.lib.virginia.edu/statlab/materials/workshops/MatchingMethods.zip" rel="noopener" target="_blank">2014 workshop</a> on matching methods. In this brief article, we demonstrate how to get started with matching methods using R and the <a href="https://gking.harvard.edu/matchit" rel="noopener" target="_blank">MatchIt</a> package.</p>
<p>To begin we need to load some data. For demonstration purposes we&#8217;ll use a sample of the 2015 <a href="https://www.cdc.gov/brfss/index.html" rel="noopener" target="_blank">BRFSS survey</a> (pronounced bur-fiss). BRFSS stands for Behavioral Risk Factor Surveillance System. BRFSS is a CDC telephone survey that collects state data about U.S. residents regarding their health-related risk behaviors and chronic health conditions. The entire survey has over 400,000 records and over 300 variables. The sample we&#8217;ll work with has 5000 records and 7 variables.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
brfss &lt;- read.csv(&quot;http://static.lib.virginia.edu/statlab/materials/data/brfss_2015_sample.csv&quot;)
summary(brfss)
  COPD          SMOKE              RACE         AGE           SEX           WTLBS        AVEDRNK2     
 No :4707   Min.   :0.0000   Black   : 308   18-24: 258   Female:2521   Min.   : 85   Min.   : 1.000  
 Yes: 293   1st Qu.:0.0000   Hispanic: 339   25-34: 599   Male  :2479   1st Qu.:148   1st Qu.: 1.000  
            Median :0.0000   Other   : 254   35-44: 667                 Median :172   Median : 2.000  
            Mean   :0.1524   White   :4099   45-54: 914                 Mean   :178   Mean   : 2.122  
            3rd Qu.:0.0000                   55-64:1122                 3rd Qu.:200   3rd Qu.: 2.000  
            Max.   :1.0000                   65+  :1440                 Max.   :527   Max.   :30.000  

</pre>
</div>
<p>The summary provides details on the seven variables:</p>
<p>COPD: Ever told you have chronic obstructive pulmonary disease (COPD)?<br />
SMOKE: Adults who are current smokers (0 = no, 1 = yes)<br />
RACE: Race group<br />
AGE: age group<br />
SEX: gender<br />
WTLBS: weight in lbs<br />
AVEDRNK2: During the past 30 days, when you drank, how many drinks did you drink on average?</p>
<p>We wish to investigate the effect of smoking on COPD. Does smoking increase the chance of contracting COPD? Obviously this is not something we could carry out as a randomized experiment. But perhaps using this observational data and matching methods we can simulate what our data might look like had we carried out a randomized experiment. We can create two groups, smokers and non-smokers, who are roughly equivalent in age, race, sex, weight and alcohol consumption. (Please note this is only for educational purposes. While the data is real and the methods are sound, we would certainly include several other variables as well as enlist the help of doctors and epidemiologists to investigate a research question like this.)</p>
<p>Before we start matching, let&#8217;s check the balance and overlap of our data. By balance we mean that the distributions of our data in the smoking and non-smoking groups are similar. By overlap, we mean that the continuous variables in the smoking and non-smoking groups span the same range of values. We can informally check both with some plots. Notice below we use the <code>factor()</code> function to ensure ggplot recognizes smoking as a categorical variable. We have smoking stored in our data as a numeric column of zeroes and ones because that&#8217;s how the MatchIt package requires treatment variables to be stored. </p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
library(ggplot2)
p &lt;- ggplot(brfss, aes(fill = factor(SMOKE))) + 
  geom_bar(position = &quot;dodge&quot;) + 
  scale_fill_discrete(&quot;Smoke&quot;)
p + aes(x = AGE)
p + aes(x = RACE)
p + aes(x = SEX)

</pre>
</div>
<p><a href="/files/pre_match_age.png"><img src="https://data.library.virginia.edu/files/pre_match_age.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6580" srcset="https://data.library.virginia.edu/files/pre_match_age.png 600w, https://data.library.virginia.edu/files/pre_match_age-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p><a href="/files/pre_match_race.png"><img src="https://data.library.virginia.edu/files/pre_match_race.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6581" srcset="https://data.library.virginia.edu/files/pre_match_race.png 600w, https://data.library.virginia.edu/files/pre_match_race-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p><a href="/files/pre_match_sex.png"><img src="https://data.library.virginia.edu/files/pre_match_sex.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6582" srcset="https://data.library.virginia.edu/files/pre_match_sex.png 600w, https://data.library.virginia.edu/files/pre_match_sex-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p>Above we notice a lack of balance. For example, the number of non-smokers increase with age while the number of smokers stays fairly constant. </p>
<p>To check the balance and overlap of the continuous weight and drink variables we plot histograms.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
ggplot(brfss, aes(x = WTLBS, fill = factor(SMOKE))) + 
  geom_histogram(position = "identity") +
  scale_fill_discrete("Smoke")
 
ggplot(brfss, aes(x = AVEDRNK2, fill = factor(SMOKE))) + 
  geom_histogram(position = "identity", binwidth = 1) +
  scale_fill_discrete("Smoke")

</pre>
</div>
<p><a href="/files/pre_match_wtlbs.png"><img src="https://data.library.virginia.edu/files/pre_match_wtlbs.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6583" srcset="https://data.library.virginia.edu/files/pre_match_wtlbs.png 600w, https://data.library.virginia.edu/files/pre_match_wtlbs-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p><a href="/files/pre_match_avedrnk2.png"><img src="https://data.library.virginia.edu/files/pre_match_avedrnk2.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6584" srcset="https://data.library.virginia.edu/files/pre_match_avedrnk2.png 600w, https://data.library.virginia.edu/files/pre_match_avedrnk2-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p>The balance maybe looks OK but there appears to be a slight lack of overlap at the higher values. We can investigate more closely by looking at the quantiles within each group.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
tapply(brfss$WTLBS, brfss$SMOKE, quantile, probs = seq(0.2, 1, 0.1))
$`0` 	
 20%  30%  40%  50%  60%  70%  80%  90% 100% 
 140  150  163  175  185  200  212  240  522 

$`1`
  20%   30%   40%   50%   60%   70%   80%   90%  100% 
140.0 150.0 160.0 172.5 180.0 195.0 209.8 235.0 506.0 


tapply(brfss$AVEDRNK2, brfss$SMOKE, quantile, probs = seq(0.2, 1, 0.1))
$`0`
 20%  30%  40%  50%  60%  70%  80%  90% 100% 
   1    1    1    1    2    2    2    3   30 

$`1`
 20%  30%  40%  50%  60%  70%  80%  90% 100% 
   1    2    2    2    3    3    4    6   30 

</pre>
</div>
<p>We see that once we get past the 30th quantile the non-smokers begin to outweigh the smokers, and the smokers begin to outdrink the non-smokers, producing a lack of balance. On the other hand, it seems the lack of overlap isn&#8217;t as bad as we thought.</p>
<p>At this point we&#8217;re ready to proceed to matching.</p>
<p>The idea of matching isn&#8217;t complicated. We want to simply find subjects with matching covariates among the smokers and non-smokers. However it&#8217;s often difficult to find exact matches, so instead we define a &#8220;closeness&#8221; or &#8220;distance&#8221; metric and use that to generate matches. In this tutorial we&#8217;ll use Nearest Neighbor Matching which is the default method in the MatchIt package. Nearest Neighbor Matching selects the best control (non-smoker) for each treated subject (smoker) using a distance measure called the propensity score. The end result is two groups of equal size and (hopefully) similar distributions of covariates. </p>
<p>The propensity score is the estimated probability of receiving treatment (ie, being a smoker), conditional on the covariates. If two subjects, one who is a smoker and the other who is not, have similar propensity scores, then we think of them as potential matches. </p>
<p>To carry out Nearest Neighbor Matching we load the MatchIt package and use the <code>matchit()</code> function. Notice we need to assign the result of the <code>matchit()</code> function to an object. Below we name it &#8220;m.out&#8221;, but you can name it something else if you like. <code>matchit()</code> uses R&#8217;s formula syntax to define what we want to match on. On the left side of the tilde (~) is SMOKE. That&#8217;s our treatment variable. On the right side of the tilde are the variables we want to match on. We have kept it simple but you can match on interactions and higher powers. Also notice we have not included our dependent variable, COPD! That is by design. At this step we are trying to create balance across covariates among smokers and non-smokers. The analysis of COPD comes after the matching procedure.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
install.packages("MatchIt")
library(MatchIt)
m.out &lt;- matchit(SMOKE ~ RACE + AGE + SEX + WTLBS + AVEDRNK2, data = brfss)

</pre>
</div>
<p>That should run fairly quickly on just about any computer. The next step is to investigate the results of the matching procedure. Did we improve balance? Are the smokers and non-smokers similar across age, race, weight, number of drinks and sex? The quickest way to check this is to plot a summary of the results, like so:</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
s.out &lt;- summary(m.out, standardize = TRUE)
plot(s.out)

</pre>
</div>
<p>First we call <code>summary()</code> on m.out and save to a new object called &#8220;s.out&#8221;. For the plot to work we need to also set the <code>standardize</code> argument to TRUE. Then we call <code>plot()</code> on the s.out object. R will allow you to click on points to label them. When finished, click Esc. We labeled 3 points. The result is below.</p>
<p><a href="/files/post_match_summary.png"><img src="https://data.library.virginia.edu/files/post_match_summary.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6585" srcset="https://data.library.virginia.edu/files/post_match_summary.png 600w, https://data.library.virginia.edu/files/post_match_summary-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p>On the left side of the plot is the standardized difference in means of covariates between smokers and non-smokers for all the data. We see that distance (propensity score) is the largest, followed by number of drinks (AVEDRNK2) and the AGE65+ group. This tells us that prior to matching we had, for example, large differences in the mean values of AVEDRNK2 between smokers and non-smokers. The right side shows the standardized difference in means <em>after</em> matching. We hope to see all the points near 0. Specifically, we want to see large differences in means become smaller. The three largest differences prior to matching are now tiny. The dark lines show mean differences that <em>increased</em> after balance. This is actually common when you match on covariates that were already pretty well balanced to begin with. Since the standardized mean difference is still less than 0.1, we&#8217;re not too concerned about it.</p>
<p>We can also compare the distribution of propensity scores (distance) before and after matching.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
plot(m.out,  type = "jitter", interactive = FALSE)
plot(m.out,  type = "hist")

</pre>
</div>
<p><a href="/files/post_match_jitter.png"><img src="https://data.library.virginia.edu/files/post_match_jitter.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6586" srcset="https://data.library.virginia.edu/files/post_match_jitter.png 600w, https://data.library.virginia.edu/files/post_match_jitter-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p><a href="/files/post_match_hist.png"><img src="https://data.library.virginia.edu/files/post_match_hist.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6594" srcset="https://data.library.virginia.edu/files/post_match_hist.png 600w, https://data.library.virginia.edu/files/post_match_hist-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p>What we want to see is that the Matched Treated (smokers) and Matched Control (non-smokers) distributions are roughly similar. We like what we see here. </p>
<p>We can also evaluate the matching results using tabular output. Just call <code>summary()</code> on the &#8220;m.out&#8221; object. Below is the results of our matching procedure. </p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
summary(m.out)

Call:
matchit(formula = SMOKE ~ RACE + AGE + SEX + WTLBS + AVEDRNK2, 
    data = brfss)

Summary of balance for all data:
             Means Treated Means Control SD Control Mean Diff eQQ Med eQQ Mean eQQ Max
distance            0.1991        0.1440     0.0799    0.0551  0.0448   0.0547  0.1816
RACEBlack           0.1194        0.0512     0.2204    0.0682  0.0000   0.0682  1.0000
RACEHispanic        0.0709        0.0672     0.2505    0.0036  0.0000   0.0026  1.0000
RACEOther           0.0682        0.0477     0.2131    0.0206  0.0000   0.0197  1.0000
RACEWhite           0.7415        0.8339     0.3722   -0.0924  0.0000   0.0919  1.0000
AGE25-34            0.1824        0.1085     0.3111    0.0739  0.0000   0.0735  1.0000
AGE35-44            0.1811        0.1248     0.3306    0.0563  0.0000   0.0564  1.0000
AGE45-54            0.1837        0.1826     0.3864    0.0011  0.0000   0.0013  1.0000
AGE55-64            0.2192        0.2253     0.4179   -0.0062  0.0000   0.0066  1.0000
AGE65+              0.1640        0.3103     0.4627   -0.1462  0.0000   0.1470  1.0000
SEXMale             0.5459        0.4868     0.4999    0.0591  0.0000   0.0591  1.0000
WTLBS             177.7561      177.9875    43.8187   -0.2314  0.0000   2.1432 50.0000
AVEDRNK2            2.9843        1.9672     1.8102    1.0171  1.0000   1.0000  4.0000


Summary of balance for matched data:
             Means Treated Means Control SD Control Mean Diff eQQ Med eQQ Mean eQQ Max
distance            0.1991        0.1986     0.1086    0.0004       0   0.0006  0.0283
RACEBlack           0.1194        0.1155     0.3198    0.0039       0   0.0039  1.0000
RACEHispanic        0.0709        0.0669     0.2501    0.0039       0   0.0039  1.0000
RACEOther           0.0682        0.0761     0.2654   -0.0079       0   0.0079  1.0000
RACEWhite           0.7415        0.7415     0.4381    0.0000       0   0.0000  0.0000
AGE25-34            0.1824        0.1916     0.3938   -0.0092       0   0.0092  1.0000
AGE35-44            0.1811        0.1903     0.3928   -0.0092       0   0.0092  1.0000
AGE45-54            0.1837        0.1850     0.3886   -0.0013       0   0.0013  1.0000
AGE55-64            0.2192        0.1890     0.3917    0.0302       0   0.0302  1.0000
AGE65+              0.1640        0.1588     0.3657    0.0052       0   0.0052  1.0000
SEXMale             0.5459        0.5276     0.4996    0.0184       0   0.0184  1.0000
WTLBS             177.7561      177.8207    42.4245   -0.0646       1   2.7788 60.0000
AVEDRNK2            2.9843        2.9423     2.7596    0.0420       0   0.2756  3.0000

Percent Balance Improvement:
             Mean Diff.  eQQ Med  eQQ Mean  eQQ Max
distance        99.1869  99.9585   98.9125  84.3921
RACEBlack       94.2289   0.0000   94.2308   0.0000
RACEHispanic    -8.8341   0.0000  -50.0000   0.0000
RACEOther       61.7348   0.0000   60.0000   0.0000
RACEWhite      100.0000   0.0000  100.0000 100.0000
AGE25-34        87.5647   0.0000   87.5000   0.0000
AGE35-44        83.6772   0.0000   83.7209   0.0000
AGE45-54       -19.9887   0.0000    0.0000   0.0000
AGE55-64      -388.2488   0.0000 -360.0000   0.0000
AGE65+          96.4106   0.0000   96.4286   0.0000
SEXMale         68.9365   0.0000   68.8889   0.0000
WTLBS           72.1013     -Inf  -29.6583 -20.0000
AVEDRNK2        95.8709 100.0000   72.4409  25.0000

Sample sizes:
          Control Treated
All          4238     762
Matched       762     762
Unmatched    3476       0
Discarded       0       0

</pre>
</div>
<p>The first two sections look at all the data and the matched data, respectively. The first, second and fourth columns are probably the easiest to examine. The first and second columns show the means for treated (smokers) and control (non-smokers) groups. Prior to matching, for example, we have 16% of smokers over age 65 versus 31% who are not smokers. That&#8217;s an absolute difference of about 15%. After matching we have roughly an equal proportion of subjects over age 65 in both groups with a negligible mean difference. The third section, Percent Balance Improvement, shows how much we have increased or decreased balance. Negative numbers in the Mean Diff column indicate covariates where balance actually got worse. The AGE55-64 value of -388 seems pretty terrible. What happened was the balance went from 21.9% vs 22.5% pre-match to 21.9% vs 18.9% post-match. Ideally we don&#8217;t want balance getting worse, but in this case the balance is still quite good. The last section tells us we now have equal numbers (762) in both the treated and control groups.</p>
<p>The columns labeled eQQ refer to empirical quantile-quantile plots. They provide the median, mean, and maximum distance between the empirical quantile functions of the treated and control groups. Values greater than 0 indicate deviations between the groups in some part of the empirical distributions. These are most useful for continuous variables. We can view these plots by calling <code>plot()</code> on the matching object. The <code>which.xs</code> argument allows us to specify which variables to plot. Below we plot weight and number of drinks.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
plot(m.out, which.xs = c("WTLBS", "AVEDRNK2"))

</pre>
</div>
<p><a href="/files/post_match_qq.png"><img src="https://data.library.virginia.edu/files/post_match_qq.png" alt="" width="600" height="430" class="aligncenter size-full wp-image-6587" srcset="https://data.library.virginia.edu/files/post_match_qq.png 600w, https://data.library.virginia.edu/files/post_match_qq-300x215.png 300w" sizes="(max-width: 600px) 100vw, 600px" /></a></p>
<p>We hope to see the points in the right column (Matched) falling between the dotted lines. The idea is that if both groups, smokers and non-smokers, have good balance then the quantiles should lie on a 45-degree line. Once again we like what we see.</p>
<p>When we&#8217;re satisfied with the results of the matching procedure, the next step is to create a new data frame that contains only the matched data. For this we use the <code>match.data()</code> function on the matching object. Below we create a new data frame called brfss.match.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
brfss.match &lt;- match.data(m.out)

</pre>
</div>
<p>And now we&#8217;re ready to perform our statistical analysis as if our data had been generated through randomization. For instance, we might perform logistic regression to analyze how smoking affects the probability of contracting COPD.</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
brfss.match$SMOKE &lt;- factor(brfss.match$SMOKE, labels = c(&quot;No&quot;, &quot;Yes&quot;))
mod &lt;- glm(COPD ~ SMOKE + AGE + RACE + SEX + WTLBS + AVEDRNK2, 
           data = brfss.match, family = &quot;binomial&quot;)
exp(confint(mod, parm = &quot;SMOKEYes&quot;))

   2.5 %   97.5 % 
2.868077 7.091090 

</pre>
</div>
<p>It appears that smokers are at least 2.9 times more likely to report COPD than non-smokers, controlling for age, sex, race, weight and drinking. </p>
<p>There is much more to learn about matching methods. We demonstrated Nearest Neighbor Matching, but there are several other methods. The MatchIt User&#8217;s Guide provides a nice overview of how to implement various matching methods: <a href="https://r.iq.harvard.edu/docs/matchit/2.4-20/User_s_Guide_to.html" rel="noopener" target="_blank">https://r.iq.harvard.edu/docs/matchit/2.4-20/User_s_Guide_to.html</a></p>
<p>It&#8217;s worth pointing out that matching does not necessarily guarantee that each treated subject will have a matching control that has identical covariate values. The only guarantee is that groups of individuals with similar distance measures (eg, propensity scores) will have similar covariate distributions. Having said that, it is possible to see which control subject was matched with which treated subject. The matching object has a <code>match.matrix</code> component, where the row names correspond to the names of the treated, and the cells correspond to the names of the matched controls. Here are the first few matches in our m.out match.matrix:</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
head(m.out$match.matrix)
   1     
29 "3128"
44 "3957"
62 "4669"
81 "1970"
82 "2849"
87 "4754"

</pre>
</div>
<p>So row 29 of brfss was a treated subject (a smoker) matched to the control subject in row 3128 (a non-smoker). If we compare them we notice they don&#8217;t exactly match up:</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
brfss[29,]
   COPD SMOKE     RACE   AGE  SEX WTLBS AVEDRNK2
29   No     1 Hispanic 25-34 Male   150       10
brfss[3128,]
     COPD SMOKE  RACE   AGE  SEX WTLBS AVEDRNK2
3128   No     0 Other 25-34 Male   164        8

</pre>
</div>
<p>The most glaring difference is RACE. But recall, they weren&#8217;t matched on the specific covariates but rather their propensity score. We can compare their propensity scores as follows (taking advantage of the fact that the row names in the matched data frame are the same as those in the original data frame):</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
i &lt;- rownames(brfss.match) %in% c(29,3128)
brfss.match[i,]
     COPD SMOKE     RACE   AGE  SEX WTLBS AVEDRNK2  distance weights
29     No   Yes Hispanic 25-34 Male   150       10 0.4776235       1
3128   No    No    Other 25-34 Male   164        8 0.4634368       1

</pre>
</div>
<p>The propensity score is in the distance column. According to the propensity score, these subjects are similar. Matching on this distance metric helps ensure the smoking and non-smoking groups have similar covariate distributions. So even those these two specific subjects do not match on RACE, overall the smoking and non-smoking groups are balanced on RACE.</p>
<p>We mentioned earlier that the propensity score is the probability of receiving treatment (ie, being a smoker), conditional on the covariates. The <code>matchit()</code> function calculates this for us but we can do it as well by performing a logistic regression of SMOKE on the covariates that we want to balance on. Notice the formula is identical to the one we used with <code>matchit()</code>. </p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
pscore &lt;- glm(SMOKE ~ RACE + AGE + SEX + WTLBS + AVEDRNK2, 
              data = brfss, family = binomial)

</pre>
</div>
<p>Here are the first 6 propensity scores in the brfss.match data frame (again, the row numbers correspond to the rows in our original brfss data frame):</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
head(brfss.match[, "distance", drop = F])
     distance
1  0.19127152
3  0.08129118
13 0.10868555
14 0.41062392
21 0.07483546
22 0.32779268

</pre>
</div>
<p>We get the same results by using our model to make predictions for the same subjects:</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
predict(pscore, type = "response")[c(1,3,13,14,21,22)]
         1          3         13         14         21         22 
0.19127152 0.08129118 0.10868555 0.41062392 0.07483546 0.32779268 

</pre>
</div>
<p>Another type of distance measure is the <em>linear propensity score</em>. It&#8217;s just the log-odds version of the propensity score. Whereas the probability-based propensity score is bounded from 0 to 1, the linear propensity score has no such bounds. This means we can make better matches in the lower and upper extremes of the scores since the values are not being compressed near 0 or 1. In section 6.2 of her paper, Stuart actually recommends using the linear propensity score. Fortunately MatchIt makes it easy to do. Simply set the <code>distance</code> argument to <code>"linear.logit"</code>:</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
m.out.lp &lt;- matchit(SMOKE ~ RACE + AGE + SEX + WTLBS + AVEDRNK2, data = brfss, 
                 distance = &quot;linear.logit&quot;)

</pre>
</div>
<p>The resulting propensity scores are on the log-odds scale, which we can verify as we did before:</p>
<div style="padding-left: 40px;font-size: 80%">
<pre>
brfss.match2 &lt;- match.data(m.out.lp)
head(brfss.match2[, &quot;distance&quot;, drop = F])
     distance
1  -1.4417693
2  -2.0709984
14 -0.3613867
21 -2.5146797
22 -0.7181855
25 -1.9113250

predict(pscore)[c(1,2,14,21,22, 25)] # default prediction is on log-odds scale
         1          2         14         21         22         25 
-1.4417693 -2.0709984 -0.3613867 -2.5146797 -0.7181855 -1.9113250 

</pre>
</div>
<p>Notice that matching on the linear propensity score has resulted in different subjects being selected. We leave it as an exercise for the interested reader to verify that the improvement in balance is essentially the same as the matching performed on the probability-based propensity score. </p>
<p>To learn more about matching methods and causal inference in general, please see the following references:</p>
<ul>
<li>Claibourn, M. (2014). Matching Methods for Causal Inference. Workshop presented at the UVa Library. <a href="http://static.lib.virginia.edu/statlab/materials/workshops/MatchingMethods.zip" rel="noopener" target="_blank">http://static.lib.virginia.edu/statlab/materials/workshops/MatchingMethods.zip</a></li>
<li>Gelman, A. and Hill, J. (2007). <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge. Chapters 9 and 10.</li>
<li>Ho, D., Imai K., King, G., Stuart, E. (2011). MatchIt: Nonparametric Preprocessing for Parametric Causal Inference. <em>Journal of Statistical Software</em>, Vol. 42, No. 8, pp. 1-28. URL <a href="http://www.jstatsoft.org/v42/i08/" rel="noopener" target="_blank">http://www.jstatsoft.org/v42/i08/</a> </li>
<li>Stuart, E. (2010). Matching Methods for Causal Inference: A Review and a Look Forward. <em>Statistical Science</em>. Vol. 25, No. 1, 1–21. DOI: <a href="https://dx.doi.org/10.1214%2F09-STS313" rel="noopener" target="_blank">10.1214/09-STS313</a></li>
</ul>
<p>For questions or clarifications regarding this article, contact the UVa Library StatLab: <a href="mailto:statlab@virginia.edu">statlab@virginia.edu</a></p>
<address>
Clay Ford<br />
Statistical Research Consultant<br />
University of Virginia Library<br />
April 24, 2018<br />
</address>
      </div>
      <footer>

      </footer>
                </article>
                    </div>
      </div><!-- /#main -->
              <aside id="sidebar" class="threecol last" role="complementary">
              <div class="container">
          <div id="sidebar-area-top">
  <article id="rpjc_widget_cat_recent_posts-2" class="widget-1 widget-first widget rpjc_widget_cat_recent_posts widget_recent_entries"><div class="widget-1 widget-first container"><h3>Latest News</h3><ul><li><a href="https://data.library.virginia.edu/sars-cov-2-update/">Service  Update</a></li><li><a href="https://data.library.virginia.edu/2019-2020-statlab-fellows/">2019-2020 StatLab Fellows</a></li></ul></div></article></div>
<nav id="nav-utility">
  <div class="menu-research-data-services-container"><ul id="menu-research-data-services" class="menu"><li id="menu-item-1599" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-1599"><a href="/datasources/">Data Discovery</a>
<ul class="sub-menu">
	<li id="menu-item-1601" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1601"><a href="/datasources/licensed/">Licensed Data Sources</a></li>
	<li id="menu-item-2480" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2480"><a href="http://guides.lib.virginia.edu/data">Research Guide</a></li>
</ul>
</li>
<li id="menu-item-1602" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-1602"><a href="/data-management/">Research Data Management</a>
<ul class="sub-menu">
	<li id="menu-item-1603" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1603"><a href="/data-management/dmp-support/">Data Management Planning Support</a></li>
	<li id="menu-item-1604" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1604"><a href="/?page_id=1286">What is Data Management?</a></li>
	<li id="menu-item-1605" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1605"><a href="/data-management/plan/">Data Management Components</a></li>
	<li id="menu-item-1654" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1654"><a href="/data-management/fall2014/">Past Data Management Workshops</a></li>
</ul>
</li>
<li id="menu-item-1620" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-1620"><a href="/research-software/">Research Software</a>
<ul class="sub-menu">
	<li id="menu-item-1621" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1621"><a href="/research-software/amos/">AMOS</a></li>
	<li id="menu-item-1622" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1622"><a href="/research-software/ansys/">Ansys</a></li>
	<li id="menu-item-1623" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1623"><a href="/research-software/arcinfo-by-esri/">GIS Software</a></li>
	<li id="menu-item-1624" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1624"><a href="/research-software/idl/">IDL</a></li>
	<li id="menu-item-1625" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1625"><a href="/research-software/labview/">LabVIEW</a></li>
	<li id="menu-item-1627" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1627"><a href="/research-software/mathematica/">Mathematica for Staff and Faculty</a></li>
	<li id="menu-item-1629" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1629"><a href="/research-software/minitab-2/">Minitab for Windows</a></li>
	<li id="menu-item-1631" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1631"><a href="/research-software/originpro/">OriginPro</a></li>
	<li id="menu-item-1632" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1632"><a href="/research-software/other-software/">Other Software</a></li>
	<li id="menu-item-1633" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1633"><a href="/research-software/oxygen/">oXygen</a></li>
	<li id="menu-item-1635" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1635"><a href="/research-software/sas/">SAS</a></li>
	<li id="menu-item-1638" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1638"><a href="/research-software/spss/">SPSS</a></li>
	<li id="menu-item-1639" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1639"><a href="/research-software/stata/">Stata</a></li>
</ul>
</li>
<li id="menu-item-1641" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-1641"><a href="/statlab/">StatLab: Data Analytics</a>
<ul class="sub-menu">
	<li id="menu-item-1642" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1642"><a href="/statlab/consulting/">Consults &amp; Collaborations</a></li>
	<li id="menu-item-3259" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-3259"><a href="/category/statlab-articles/">StatLab Articles</a></li>
</ul>
</li>
<li id="menu-item-4661" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4661"><a href="/sne/">Social, Natural, Engineering Sciences</a></li>
<li id="menu-item-4131" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4131"><a href="/training/">Workshops</a></li>
<li id="menu-item-1617" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1617"><a href="/rds-staff/">The Team</a></li>
<li id="menu-item-1613" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1613"><a href="/faq/">FAQs</a></li>
<li id="menu-item-1956" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1956"><a href="/related-resources/">Related Resources</a></li>
</ul></div></nav>
<div id="sidebar-area-bottom">
  </div>
        </div>
            </aside><!-- /#sidebar -->
        </div><!-- /#content -->
    </div></div><!-- /.row /.container -->
<div class="container footer-container"><div class="row row-container clearfix">
    <footer id="content-info" class="row" role="contentinfo">
            <div class="container">
                <p id="copyright">&copy; 2020 by the Rector and Visitors of the <a href="http://www.virginia.edu">University of Virginia</a></p>
      </div>
    </footer>
    </div></div><!-- /.row /.container -->
  </div><!-- /#wrap -->


<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://analytics.lib.virginia.edu/" : "http://analytics.lib.virginia.edu/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 17);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="https://analytics.lib.virginia.edu/piwik.php?idsite=17" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->





<!-- Start Announcement - Announcer plugin -->
<div class="announcer announcer-top-float announcer-style1 announcer-topbar" style="border-color:#ffffff;background-color:#e57200;color:#ffffff;" data-effect="fade" data-effdur="1000" data-pos="top-float" data-id="6"><div class="announcer-content"><div style="margin-left:105px;"><strong>Libraries have temporarily suspended in-person service; expanded online resources available</strong><br><br>

Several avenues are available for members of the UVA community needing Library resources, including HathiTrust’s newly-released trove of copyrighted digital material, open educational resources, online journals, databases, and e-books. Additionally, subject liaisons can help locate appropriate online materials. <a href="https://www.library.virginia.edu/news/covid-19"  style="color: #fff;">Find out more ></a>
</div></div></div>
<!-- End Announcement - Announcer plugin -->
<script type='text/javascript' src='/wp-content/plugins/skip-to/js/skipToInit.js?ver=1.1'></script>
<script type='text/javascript' src='/wp-content/plugins/skip-to/js/SkipTo.min.js?ver=2.0.0'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=5.1.1'></script>


<script src="/wp-content/themes/libweb-base/js/libs/css3-mediaqueries.js"></script>

<!-- include Cycle plugin -->
<script type="text/javascript" src="/wp-content/themes/libweb-base/js/libs/jquery.cycle.all.js"></script>
<script src="/wp-content/themes/libweb-base/js/plugins.js"></script>


  <!--[if lt IE 7]>
    <script defer src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script defer>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->


<script src="/wp-content/themes/libweb-base/js/script.js"></script>
<script src="/wp-content/themes/libweb-base/js/gravity_scripts.js"></script>
<script src="/wp-content/themes/libweb-base/js/libs/bootstrap.min.js"></script>

</body>
</html>
